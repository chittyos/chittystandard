name: 1Password Rotation Audit

on:
  workflow_dispatch:
  schedule:
    - cron: "25 3 * * *"

permissions:
  contents: read
  issues: write

jobs:
  audit:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          [[ -n "${GH_TOKEN:-}" ]] || { echo "Missing ORG_AUTOMATION_TOKEN"; exit 1; }
          [[ -n "${OP_SERVICE_ACCOUNT_TOKEN:-}" ]] || { echo "Missing OP_SERVICE_ACCOUNT_TOKEN"; exit 1; }
      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1
      - name: Run rotation audit
        id: rotation
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports/secret-rotation
          if bash scripts/onepassword-rotation-audit.sh .github/secret-catalog.json reports/secret-rotation; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
      - name: Upload rotation report
        uses: actions/upload-artifact@v4
        with:
          name: onepassword-rotation-report
          path: reports/secret-rotation
      - name: Open or update rotation issue on failure
        if: ${{ steps.rotation.outputs.status == 'fail' }}
        shell: bash
        run: |
          set -euo pipefail
          title="[Security] 1Password rotation policy violations"
          body="$(cat reports/secret-rotation/latest.md)"
          existing="$(gh issue list --state open --search "\"${title}\" in:title" --json number,title --jq '.[] | select(.title=="'"${title}"'") | .number' | head -n1 || true)"
          if [[ -n "${existing}" ]]; then
            gh issue comment "${existing}" --body "${body}" >/dev/null
          else
            gh issue create --title "${title}" --body "${body}" >/dev/null
          fi
